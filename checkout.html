<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paiement - ETLALA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;800&family=Lato:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" />

  <!-- Shared styles -->
  <link rel="stylesheet" href="./frontend/style/style.css" />
  <link rel="stylesheet" href="./frontend/style/navbar-styles.css" />
  <link rel="stylesheet" href="./frontend/style/navbar-dropdown.css" />
  <link rel="stylesheet" href="./frontend/style/footer-styles.css" />
  <link rel="stylesheet" href="./frontend/style/minas-colors.css" />

  <style>
    :root { --brand-green: #6E8B72; --brand-gold: #D4AF37; --ink: #222; --muted: #666; --line: #e6e2da; }
    body { background: #faf8f3; }

    .checkout-page { padding: 110px 20px 40px; }
    .co-container { max-width: 1120px; margin: 0 auto; }
    .co-title { font: 700 32px/1.1 Playfair Display, serif; color: var(--brand-green); margin: 0 0 22px; }
    .co-grid { display: grid; grid-template-columns: 1fr 420px; gap: 32px; align-items: start; }
    @media (max-width: 980px) { .co-grid { grid-template-columns: 1fr; } }

    .co-card { background: #fff; border: 1px solid var(--line); border-radius: 14px; padding: 20px; }
    .co-card + .co-card { margin-top: 16px; }
    .co-section-title { font: 600 16px/1.2 Lato, sans-serif; letter-spacing: .06em; color: var(--ink); text-transform: uppercase; margin: 6px 0 16px; }

    .co-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .co-row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 14px; }
    .co-field { display: flex; flex-direction: column; gap: 6px; }
    .co-label { font: 600 12px/1 Lato, sans-serif; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); }
    .co-input, .co-select, .co-textarea { padding: 12px 12px; border-radius: 10px; border: 1px solid var(--line); background: #fff; font: 400 14px/1.4 Lato, sans-serif; color: var(--ink); }
    .co-textarea { min-height: 90px; resize: vertical; }

    .co-ship-methods { display: grid; gap: 10px; }
    .co-radio { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--line); border-radius: 10px; background: #fff; }
    .co-radio input { accent-color: var(--brand-green); }
    .co-radio .co-radio-meta { margin-left: auto; color: var(--muted); font-weight: 600; }

    .co-summary { position: sticky; top: 84px; }

    .co-items { display: grid; gap: 14px; }
    .co-item { display: grid; grid-template-columns: 64px 1fr auto; gap: 12px; align-items: center; padding: 8px; border: 1px solid var(--line); border-radius: 12px; background: #fff; }
    .co-item img { width: 64px; height: 64px; object-fit: cover; border-radius: 10px; }
    .co-item-name { font: 600 14px/1.35 Lato, sans-serif; color: var(--ink); }
    .co-item-meta { font: 12px Lato, sans-serif; color: var(--muted); }
    .co-item-total { font: 600 14px Lato, sans-serif; color: var(--ink); }

    .co-totals { margin-top: 16px; border-top: 1px dashed var(--line); padding-top: 12px; display: grid; gap: 10px; }
    .co-row-flex { display: flex; align-items: center; justify-content: space-between; font: 600 14px Lato, sans-serif; color: var(--ink); }
    .co-row-flex.muted { color: var(--muted); font-weight: 500; }
    .co-grand { font: 700 18px Lato, sans-serif; color: var(--ink); }

    .co-cta { display: flex; gap: 12px; margin-top: 18px; }
    .btn-primary { background: var(--brand-gold); color: #5a7260; border: none; padding: 14px 16px; border-radius: 12px; font: 700 13px Lato, sans-serif; letter-spacing: .08em; text-transform: uppercase; cursor: pointer; }
    .btn-primary:disabled{ opacity: .6; cursor: not-allowed; }
    .btn-ghost { background: transparent; color: var(--brand-green); border: 1px solid var(--brand-green); padding: 14px 16px; border-radius: 12px; font: 700 13px Lato, sans-serif; letter-spacing: .08em; text-transform: uppercase; cursor: pointer; }

    .co-coupon { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 8px; }
    .co-coupon .co-input { height: 44px; }

    .co-empty { padding: 18px; background: #fff; border: 1px dashed var(--line); border-radius: 12px; color: var(--muted); }

    .co-confirm { display: none; }
    .co-confirm.active { display: block; }
    .co-confirm .cc-title { font: 700 22px Playfair Display, serif; color: var(--brand-green); margin: 0 0 8px; }
    .co-confirm p { color: var(--muted); }

  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="minimal-navbar">
    <div class="navbar-left">
      <button class="hamburger-menu" id="hamburger-btn" aria-label="Menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 12H21M3 6H21M3 18H21" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <button class="search-btn" aria-label="Rechercher">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="8" stroke="#FFFFFF" stroke-width="2"/>
          <path d="M21 21L16.65 16.65" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span class="search-text">RECHERCHER</span>
      </button>
    </div>
    <div class="navbar-center">
      <a href="/" class="brand-logo">
        <img src="./frontend/public/logo.png" alt="ETLALA" />
      </a>
    </div>
    <div class="navbar-right">
      <a href="/login" class="nav-link">CONNEXION / INSCRIPTION</a>
      <a href="#" class="account-icon" aria-label="Compte">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="8" r="4" stroke="#FFFFFF" stroke-width="2"/>
          <path d="M5 20C5 16.134 8.134 13 12 13C15.866 13 19 16.134 19 20" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </a>
      <a href="#" class="cart-link">
        <span class="cart-text">PANIER</span>
        <span class="cart-badge">0</span>
      </a>
    </div>
  </nav>

  <!-- Navbar Dropdown Overlay and Cart Dropdown -->
  <div class="navbar-dropdown-overlay"></div>
  <div class="navbar-dropdown cart-dropdown" id="cart-dropdown">
    <div class="dropdown-header">
      <h3 class="dropdown-title">Panier</h3>
      <button class="dropdown-close" data-dropdown="cart">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="dropdown-body">
      <div class="cart-items" id="cart-items"></div>
      <div class="cart-empty" id="cart-empty">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 2L7.17 4H3C1.9 4 1 4.9 1 6V18C1 19.1 1.9 20 3 20H21C22.1 20 23 19.1 23 18V6C23 4.9 22.1 4 21 4H16.83L15 2H9Z" stroke="#6E8B72" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <p>Votre panier est vide</p>
        <a href="/products.html" class="shop-now-btn">Acheter maintenant</a>
      </div>
    </div>
    <div class="dropdown-footer" id="cart-footer">
      <div class="cart-total">
        <span class="total-label">Sous-total :</span>
        <span class="total-amount" id="cart-total">$0.00</span>
      </div>
      <div class="cart-actions">
        <a href="/cart.html" class="btn-view-cart">Voir le panier</a>
        <a href="/checkout.html" class="btn-checkout">Passer au paiement</a>
      </div>
    </div>
  </div>

  <!-- Sidebar Menu (from main.js) -->
  <div class="sidebar-overlay"></div>
  <aside class="sidebar-menu">
    <div class="sidebar-header">
      <button class="sidebar-back" aria-label="Retour">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="sidebar-back-text">Retour</span>
      </button>
      <nav class="sidebar-header-nav">
        <a href="/" class="sidebar-header-link">Accueil</a>
        <a href="/gift-card" class="sidebar-header-link">Carte cadeau</a>
        <a href="/store-locator.html" class="sidebar-header-link">Trouver une boutique</a>
        <a href="/contact.html" class="sidebar-header-link">Nous contacter</a>
      </nav>
      <button class="sidebar-close" aria-label="Fermer le menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <!-- Mobile root menu -->
    <div class="sidebar-mobile-menu">
      <div class="sidebar-menu-item">
        <button class="sidebar-menu-link" data-panel="product-categories">
          <span>CATÉGORIES SOINS DE LA PEAU</span>
          <span class="sidebar-menu-arrow">
            <svg viewBox="0 0 8 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2 2L6 6L2 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </button>
      </div>
      <div class="sidebar-menu-item">
        <a href="/new-arrivals" class="sidebar-menu-link">
          <span>NOUVEAUTÉS</span>
        </a>
      </div>
      <div class="sidebar-menu-item">
        <a href="/best-sellers" class="sidebar-menu-link">
          <span>MEILLEURES VENTES</span>
        </a>
      </div>
      <div class="sidebar-menu-item">
        <a href="/contact.html" class="sidebar-menu-link">
          <span>NOUS CONTACTER</span>
        </a>
      </div>
    </div>

    <!-- Sub-panel: Product Categories -->
    <div class="sidebar-panel" id="panel-product-categories">
      <h2 class="sidebar-subpanel-title">CATÉGORIES SOINS DE LA PEAU</h2>
      <div class="sidebar-subpanel-list">
        <div class="sidebar-subpanel-item"><a href="/serums" class="sidebar-subpanel-link">Sérums</a></div>
        <div class="sidebar-subpanel-item"><a href="/moisturizers" class="sidebar-subpanel-link">Hydratants</a></div>
        <div class="sidebar-subpanel-item"><a href="/cleansers" class="sidebar-subpanel-link">Nettoyants</a></div>
        <div class="sidebar-subpanel-item"><a href="/face-masks" class="sidebar-subpanel-link">Masques pour le visage</a></div>
        <div class="sidebar-subpanel-item"><a href="/eye-care" class="sidebar-subpanel-link">Soin des yeux</a></div>
        <div class="sidebar-subpanel-item"><a href="/sunscreen" class="sidebar-subpanel-link">Écran solaire</a></div>
      </div>
    </div>
  </aside>

  <!-- Checkout Content -->
  <div class="checkout-page">
    <div class="co-container">
      <h1 class="co-title">Paiement</h1>
      <div class="co-grid">
        <!-- Left: Customer / Shipping / Payment -->
        <div>
          <div class="co-card">
            <div class="co-section-title">Informations de contact</div>
            <div class="co-row">
              <div class="co-field"><label class="co-label">Prénom</label><input id="co-first" class="co-input" type="text" placeholder="Jean" required /></div>
              <div class="co-field"><label class="co-label">Nom</label><input id="co-last" class="co-input" type="text" placeholder="Dupont" required /></div>
            </div>
            <div class="co-row">
              <div class="co-field"><label class="co-label">E-mail</label><input id="co-email" class="co-input" type="email" placeholder="jean@example.com" required /></div>
              <div class="co-field"><label class="co-label">Téléphone</label><input id="co-phone" class="co-input" type="tel" placeholder="+212 600 00 00 00" required /></div>
            </div>
          </div>

          <div class="co-card">
            <div class="co-section-title">Adresse de livraison</div>
            <div class="co-field"><label class="co-label">Adresse</label><input id="co-address" class="co-input" type="text" placeholder="123 Avenue" required /></div>
            <div class="co-row-3" style="margin-top: 10px;">
              <div class="co-field"><label class="co-label">Ville</label><input id="co-city" class="co-input" type="text" placeholder="Casablanca" required /></div>
              <div class="co-field"><label class="co-label">Code postal</label><input id="co-postal" class="co-input" type="text" placeholder="20000" required /></div>
              <div class="co-field"><label class="co-label">Pays</label>
                <select id="co-country" class="co-select">
                  <option value="Morocco">Maroc</option>
                </select>
              </div>
            </div>
            <div class="co-field" style="margin-top: 10px;">
              <label class="co-label">Notes (facultatif)</label>
              <textarea id="co-notes" class="co-textarea" placeholder="Instructions de livraison ou message..."></textarea>
            </div>
          </div>

          <div class="co-card">
            <div class="co-section-title">Mode de livraison</div>
            <div class="co-ship-methods">
              <label class="co-radio">
                <input type="radio" name="ship" value="casablanca" checked />
                <span>Livraison à Casablanca</span>
                <span class="co-radio-meta" data-ship=":19">19 DH</span>
              </label>
              <label class="co-radio">
                <input type="radio" name="ship" value="outside-casa" />
                <span>Livraison hors Casablanca</span>
                <span class="co-radio-meta" data-ship=":35">35 DH</span>
              </label>
              <div class="co-row-flex muted" style="margin-top: 4px; font-size: 12px;">
                <span>Sélectionnez votre zone de livraison</span>
                <span></span>
              </div>
            </div>
          </div>

          <div class="co-card">
            <div class="co-section-title">Paiement</div>
            <div class="co-radio">
              <input type="radio" name="pay" value="cod" checked />
              <span>Paiement à la livraison</span>
            </div>
            <div class="co-row-flex muted" style="margin-top: 8px; font-size: 12px;">
              <span>Sécurisé, aucun paiement anticipé requis.</span><span></span>
            </div>
          </div>

          <div class="co-cta">
            <button id="place-order" class="btn-primary">Passer la commande</button>
            <a class="btn-ghost" href="/products.html">Continuer vos achats</a>
          </div>

          <div id="co-confirm" class="co-confirm co-card" style="margin-top: 18px;">
            <div class="cc-title">Merci ! Votre commande est confirmée.</div>
            <p>Nous avons bien reçu votre commande et commencerons son traitement sous peu. Une confirmation a été enregistrée localement à des fins de démonstration.</p>
          </div>
        </div>

        <!-- Right: Summary -->
        <aside class="co-summary">
          <div class="co-card">
            <div class="co-section-title">Récapitulatif de commande</div>
            <div id="co-items" class="co-items"></div>
            <div class="co-coupon">
              <input id="co-coupon" class="co-input" type="text" placeholder="Code de réduction (facultatif)" />
              <button id="apply-coupon" class="btn-ghost" type="button">Appliquer</button>
            </div>
            <div class="co-totals">
              <div class="co-row-flex muted"><span>Sous-total</span><span id="co-subtotal">0 DH</span></div>
              <div class="co-row-flex muted"><span>Livraison</span><span id="co-shipping">0 DH</span></div>
              <div class="co-row-flex muted"><span>Remise</span><span id="co-discount">0 DH</span></div>
              <div class="co-row-flex co-grand"><span>Total</span><span id="co-total">0 DH</span></div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Footer anchor (main.js auto-injects footer-component.html) -->
  <div id="footer-container"></div>

  <!-- Scripts -->
  <script src="./frontend/src/main.js"></script>
  <script src="./frontend/src/navbar-dropdown.js"></script>
  <script>
    (function(){
      function readCart(){
        try { return JSON.parse(localStorage.getItem('etlala_cart') || '[]'); } catch(e){ return []; }
      }
      function money(val, useDH){ return useDH ? `${val.toFixed(0)} DH` : `$${val.toFixed(2)}`; }

      function computeCurrency(cart){ return cart.some(i => (i.currency||'').toUpperCase()==='DH'); }

      function normalize(cart){
        return cart.map(it => ({
          ...it,
          quantity: it.quantity != null ? it.quantity : (it.qty != null ? it.qty : 1),
          price: Number(it.price || 0),
          image: it.image || './frontend/public/logo.png'
        }));
      }

      function render(){
        let cart = normalize(readCart());
        const hasDH = computeCurrency(cart);
        const itemsEl = document.getElementById('co-items');
        const subEl = document.getElementById('co-subtotal');
        const shipEl = document.getElementById('co-shipping');
        const discEl = document.getElementById('co-discount');
        const totalEl = document.getElementById('co-total');

        if (!itemsEl) return;
        if (cart.length === 0){
          itemsEl.innerHTML = '<div class="co-empty">Votre panier est vide.</div>';
          subEl.textContent = hasDH ? '0 DH' : '$0.00';
          shipEl.textContent = hasDH ? '0 DH' : '$0.00';
          discEl.textContent = hasDH ? '0 DH' : '$0.00';
          totalEl.textContent = hasDH ? '0 DH' : '$0.00';
          return;
        }

        const subtotal = cart.reduce((s, it) => s + (it.price * it.quantity), 0);

        itemsEl.innerHTML = cart.map(it => `
          <div class="co-item">
            <img src="${it.image}" alt="${it.name}"/>
            <div>
              <div class="co-item-name">${it.name}</div>
              <div class="co-item-meta">Qté ${it.quantity}</div>
            </div>
            <div class="co-item-total">${money(it.price * it.quantity, hasDH)}</div>
          </div>
        `).join('');

        // shipping method - Casablanca 19 DH, outside 35 DH
        const shipRadios = document.querySelectorAll('input[name="ship"]');
        let shipping = 19; // default Casablanca
        shipRadios.forEach(r => { 
          if (r.checked){ 
            shipping = r.value === 'casablanca' ? 19 : 35; 
          } 
        });

        // coupon demo (optional): ETLALA10 => 10% off
        let discount = 0;
        const code = (document.getElementById('co-coupon').value || '').trim().toUpperCase();
        if (code === 'ETLALA10') discount = subtotal * 0.10;

        const total = Math.max(0, subtotal + shipping - discount);

        subEl.textContent = money(subtotal, hasDH);
        shipEl.textContent = money(shipping, hasDH);
        discEl.textContent = money(discount, hasDH);
        totalEl.textContent = money(total, hasDH);
      }

      function validate(){
        function val(id){ return (document.getElementById(id)?.value || '').trim(); }
        const req = ['co-first','co-last','co-email','co-phone','co-address','co-city','co-postal'];
        let ok = true;
        req.forEach(id => { const el = document.getElementById(id); if (!val(id)){ ok = false; el && (el.style.borderColor = '#c66'); } else { el && (el.style.borderColor = '#e6e2da'); } });
        return ok;
      }

      function generateUniqueOrderId(){
        // Get the current order counter from localStorage
        let orderCounter = parseInt(localStorage.getItem('etlala_order_counter') || '0', 10);
        
        // Increment the counter
        orderCounter++;
        
        // Save the new counter value
        localStorage.setItem('etlala_order_counter', orderCounter.toString());
        
        // Generate unique ID: ETL + padded counter (e.g., ETL00001, ETL00002, etc.)
        const orderId = 'ETL' + orderCounter.toString().padStart(5, '0');
        
        return { orderId, orderNumber: orderCounter };
      }

      function placeOrder(){
        if (!validate()) { alert('Veuillez remplir tous les champs obligatoires.'); return; }
        
        // Generate unique order ID
        const { orderId, orderNumber } = generateUniqueOrderId();
        
        const order = {
          orderId: orderId,
          orderNumber: orderNumber,
          ts: Date.now(),
          items: JSON.parse(localStorage.getItem('etlala_cart')||'[]'),
          contact: {
            first: document.getElementById('co-first').value.trim(),
            last: document.getElementById('co-last').value.trim(),
            email: document.getElementById('co-email').value.trim(),
            phone: document.getElementById('co-phone').value.trim()
          },
          shipping: {
            address: document.getElementById('co-address').value.trim(),
            city: document.getElementById('co-city').value.trim(),
            postal: document.getElementById('co-postal').value.trim(),
            country: document.getElementById('co-country').value,
            method: document.querySelector('input[name="ship"]:checked')?.value || 'standard',
            notes: document.getElementById('co-notes').value.trim()
          },
          payment: { method: document.querySelector('input[name="pay"]:checked')?.value || 'cod' },
          coupon: (document.getElementById('co-coupon').value||'').trim().toUpperCase()
        };
        
        // Save to last order
        try { localStorage.setItem('etlala_last_order', JSON.stringify(order)); } catch(e){}
        
        // Save to order history
        try {
          const orderHistory = JSON.parse(localStorage.getItem('etlala_order_history') || '[]');
          orderHistory.push(order);
          localStorage.setItem('etlala_order_history', JSON.stringify(orderHistory));
        } catch(e){}

        // clear cart
        localStorage.setItem('etlala_cart', '[]');
        if (typeof window.updateCartBadge === 'function') window.updateCartBadge();
        if (typeof window.updateCartDropdown === 'function') window.updateCartDropdown();

        // redirect to confirmation page
        window.location.href = '/order-confirmation.html';
      }

      // Wire events
      document.addEventListener('DOMContentLoaded', function(){
        render();
        document.querySelectorAll('input[name="ship"]').forEach(r => r.addEventListener('change', render));
        document.getElementById('apply-coupon').addEventListener('click', render);
        document.getElementById('place-order').addEventListener('click', placeOrder);
      });
    })();
  </script>
</body>
</html>
